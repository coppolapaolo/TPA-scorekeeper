<!DOCTYPE html>
<html>

<head>
    <title>Player Match</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        body {
            background: #f5f5f5;
        }

        .container {
            max-width: 960px;
        }

        .btn-group-toggle .btn {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-group-toggle .btn:not(.active) {
            color: #007bff;
            background-color: #fff;
            border-color: #007bff;
        }

        .btn-group .btn {
            color: #007bff;
            background-color: #fff;
            border-color: #007bff;
        }

        .btn-square {
            width: 50px;
            height: 50px;
            margin: 0.3em;
        }

        .border-container {
            display: inline-block;
            position: relative;
        }

        .circle {
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            border-radius: 50%;
            border: 2px solid black;
            /* Bordo nero */
            pointer-events: none;
            /* Permette al testo sottostante di essere cliccabile */
        }

        #whiteLabel,
        #grayLabel {
            font-size: 2.5em;
        }

        .container {
            overflow-x: hidden;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <h1 class="text-center mb-5">Player Match</h1>
        <form id="playerForm" class="mb-5">
            <div class="form-group">
                <label for="player1">Player 1</label>
                <input type="text" class="form-control" id="player1" placeholder="Inserisci il nome del giocatore 1"
                    onchange="saveNames()">
            </div>
            <div class="form-group">
                <label for="player2">Player 2</label>
                <input type="text" class="form-control" id="player2" placeholder="Inserisci il nome del giocatore 2"
                    onchange="saveNames()">
            </div>
            <button type="button" class="btn btn-primary" onclick="startMatch()">Start</button>
        </form>
        <h3 id="dateTitle" class="text-center mb-5" style="display: none;"></h3>
        <div id="matchContent" style="display: none;">
            <div id="players" class="justify-content-center mb-5 flex-column" style="display: none;">
                <div id="playersGroup" class="d-flex btn-group btn-group-toggle" data-toggle="buttons"
                    style="display: none;">
                    <label id="player1Label" class="btn btn-primary active">
                        <input type="radio" name="playerOptions" id="player1Option" autocomplete="off" checked> Player1
                    </label>
                    <label id="player2Label" class="btn btn-primary">
                        <input type="radio" name="playerOptions" id="player2Option" autocomplete="off"> Player2
                    </label>
                </div>
                <div id="matchScore" class="w-100" style="font-size: tiny; text-align: center;">0 - 0</div>
            </div>
            <div id="squareLabels" class="d-flex justify-content-center mb-5" style="display: none;">
                <div class="border-container">
                    <label id="whiteLabel" class="border"
                        style="width: 100px; height: 100px; background-color: white; display: flex; justify-content: center; align-items: center; font-size: 40px;"></label>
                    <span id="circle" class="circle" style="display: none;"></span>
                </div>
                <label id="grayLabel" class="border"
                    style="width: 100px; height: 100px; background-color: lightgray; display: flex; justify-content: center; align-items: center; font-size: 40px;"></label>
            </div>
            <div id="scoreButtons" class="container" style="display: none;">
                <!-- Score buttons will be added here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let biglie = 0;
        let players = {
            player1: { points: 0, biglie: 0, errori: 0, tpaScore: 0 },
            player2: { points: 0, biglie: 0, errori: 0, tpaScore: 0 }
        };
        let currentPlayer = 'player1';
        let isStartOfGame = true;
        let isBreakShot = true;
        let isBreakShotComplete = false;
        let isMKSPressed = false;
        let biglieInizioTurno = 0; // serve per il reset


        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function saveNames() {
            var player1 = document.getElementById('player1').value;
            var player2 = document.getElementById('player2').value;

            var d = new Date();
            d.setTime(d.getTime() + (60 * 60 * 24 * 60 * 1000)); // Two months
            var expires = "expires=" + d.toUTCString();

            document.cookie = "player1=" + player1 + ";" + expires + ";path=/";
            document.cookie = "player2=" + player2 + ";" + expires + ";path=/";
        }

        function toggleButtons() {
            // toggleButtons() abilita tutti i pulsanti numerici e disabilita tutti i pulsanti lettera
            // toggleButtons(3) disabilita i pulsanti da 4 a 9 e disabilita tutti gli altri 
            // toggleButtons(-2) abilita i pulsanti da 1 a 2 e disabilita tutti gli altri 
            // toggleButtons([1,3,q]) abilita i pulsanti 1, 3 e q e disabilita tutti gli altri
            // toggleButtons([M, N, x],[1,3,q]) disabilita i pulsanti M, N e x e abilita i pulsanti 1, 3 e q
            if (arguments.length === 0) {
                document.querySelectorAll('.btn-square').forEach(function (btn) {
                    if (!isNaN(btn.textContent)) {
                        btn.disabled = false;
                    } else {
                        //btn.disabled = true;
                        btn.style.display = 'none';
                    }
                });
            } else if (arguments.length === 1) {
                if (typeof arguments[0] === 'number') {
                    var tmp = arguments[0];
                    if (arguments[0] > 0) {
                        document.querySelectorAll('.btn-square').forEach(function (btn) {
                            if (!isNaN(btn.textContent)) {
                                btn.style.display = "";
                                if(parseInt(btn.textContent) > tmp) {
                                    btn.disabled = true;
                                } else {
                                    btn.disabled = false;
                                }
                            } else {
                                btn.style.display = 'none';
                            }
                        });    
                    } else {
                        document.querySelectorAll('.btn-square').forEach(function (btn) {
                            if (!isNaN(btn.textContent)) {
                                btn.style.display = "";
                                if (parseInt(btn.textContent) <= -tmp) {
                                    btn.disabled = false;
                                } else {
                                    btn.disabled = true;
                                }
                            } else {
                                btn.style.display = 'none';
                            }   
                        });
                    }
                } else if (Array.isArray(arguments[0])) {
                    var tmp = arguments[0];
                    document.querySelectorAll('.btn-square').forEach(function (btn) {
                        if (tmp.includes(btn.textContent)) {
                            btn.style.display = "";
                            btn.disabled = false;
                        } else {
                            btn.style.display = 'none';
                        }
                    });
                }
            } else {
                var buttonEnabled = arguments[0];
                var buttonsDisabled = arguments[1];
                document.querySelectorAll('.btn-square').forEach(function (btn) {
                    btn.style.display = "";
                    if (buttonEnabled.includes(btn.textContent)) {                       
                        btn.disabled = false;
                    } else if (buttonsDisabled.includes(btn.textContent)) {
                        btn.disabled = true;
                    }
                });
            }   
        }


        function startMatch() {
            biglie = 9;
            biglieInizioTurno = biglie;
            players.player1.points = 0;
            players.player2.points = 0;
            players.player1.biglie = 9;
            players.player2.biglie = 9;
            players.player1.errori = 0;
            players.player2.errori = 0;
            players.player1.tpaScore = 0;
            players.player2.tpaScore = 0;
            currentPlayer = 'player1';
            isStartOfGame = true;
            isBreakShot = true;
            isBreakShotComplete = false;
            isMKSPressed = false;
            lastButtonIsNumeric = false;

            document.getElementById('playerForm').style.display = 'none';

            var date = new Date();
            document.getElementById('dateTitle').innerHTML = date.toDateString();
            document.getElementById('dateTitle').style.display = 'block';
            document.getElementById('squareLabels').style.display = 'flex';

            document.querySelector('.justify-content-center.mb-5.flex-column').style.display = 'flex';
            var player1 = getCookie('player1');
            var player2 = getCookie('player2');
            document.getElementById('player1Label').textContent = player1;
            document.getElementById('player2Label').textContent = player2;
            document.getElementById('matchContent').style.display = 'block';
            document.getElementById('playersGroup').style.display = 'block';

            var scoreButtons = document.getElementById('scoreButtons');
            var buttons = [
                [null, '1', '2', '3', null],
                [null, '4', '5', '6', null],
                [null, '7', '8', '9', null],
                [null, '0', null],
                [null, 'M', 'K', 'S', null],
                [null, 'P', null, 'N', null],
                [null, null, 'n', 'x', null, null],
                [null, null, 'p', 'q', null, null]
            ];

            buttons.forEach(function (row) {
                var div = document.createElement('div');
                div.className = 'row justify-content-center mb-2';
                row.forEach(function (button) {
                    var col = document.createElement('div');
                    if (button === null) {
                        col.className = 'col-2';
                    } else {
                        col.className = 'col-2';
                        var btn = document.createElement('button');
                        btn.className = 'btn btn-secondary btn-square';
                        btn.textContent = button;
                        if (isNaN(button)) {
                            //btn.disabled = true;
                            btn.style.display = 'none';
                        }
                        col.appendChild(btn);
                    }
                    div.appendChild(col);
                    if (button !== null) {
                        btn.addEventListener('click', function () {
                            if (!isNaN(button)) {
                                if (isStartOfGame) {//spaccata
                                    if (lastButtonIsNumeric) { //ho già segnato le biglie totali. Ora devo segnare le biglie in spaccata in alto a sinistra
                                        document.getElementById('whiteLabel').innerHTML = '<sup>' + button + '</sup>' + document.getElementById('whiteLabel').innerHTML;
                                        toggleButtons(['M', 'K', 'S', 'P', 'N']);
                                        lastButtonIsNumeric = false;
                                        isStartOfGame = (biglie === 9); // se ho segnato 9 biglie in spaccata, allora è inizio di game
                                    } else {
                                        document.getElementById('whiteLabel').innerText = button;
                                        if (button === '0') {
                                            isStartOfGame = false;
                                            toggleButtons(['M', 'K', 'S','P','N']);
                                        } else {//devo segnare le biglie totali e abilitare i pulsanti numerici da 1 a button per segnare le biglie in spaccata
                                            biglie -= parseInt(button);
                                            players[currentPlayer].biglie += parseInt(button);
                                            toggleButtons(-parseInt(button));
                                            lastButtonIsNumeric = true;
                                        }
                                    }
                                } else {
                                    biglie -= parseInt(button);
                                    players[currentPlayer].biglie += parseInt(button);
                                    document.getElementById('whiteLabel').innerText = button;
                                    toggleButtons(['M', 'K', 'S', 'P', 'N']);
                                }
                                // If biglie is 0, aggiorno il punteggio
                                if (biglie === 0) {
                                    document.getElementById('circle').style.display = 'block';
                                    // fine game. aggiorno punteggio e disabilito i pulsanti lettera
                                    players[currentPlayer].points++;
                                    document.getElementById('matchScore').innerText = players.player1.points + ' - ' + players.player2.points;
                                    if (biglieInizioTurno === 9) {//aperto e chiuso un tavolo. devo segnare quanti in spaccata 
                                        toggleButtons(-9);
                                        lastButtonIsNumeric = true;

                                    } else {
                                        toggleButtons([]);
                                    }
                                }
                            } else {
                                if (['M', 'K', 'S'].includes(button)) {
                                    document.getElementById('whiteLabel').innerHTML += button;
                                    if (button === 'S') {//dopo una S puo' esserci una x oppure, se l'inizio di un game potrebbe esserci una p
                                        if (isBreakShotComplete) {
                                            toggleButtons(['x', 'P', 'N']);
                                        } else {
                                            toggleButtons(['x', 'p', 'P', 'N', 'M']);
                                        }
                                    } else if (button === 'M') {
                                        toggleButtons(['n','q','P','N']);
                                    } else {
                                        toggleButtons(['P', 'N']);  
                                    }
                                    isStartOfGame = false;
                                    lastButtonIsNumeric = false;
                                }
                                else if (['n', 'x', 'p', 'q'].includes(button)) {
                                    document.getElementById('whiteLabel').innerHTML += '<sup>' + button + '</sup>';
                                }
                                else if (['P', 'N'].includes(button)) {
                                    let grayLabelText = document.getElementById('grayLabel').innerText;
                                    if (grayLabelText[grayLabelText.length - 1] === button) {
                                        document.getElementById('grayLabel').innerText = grayLabelText.slice(0, -1);
                                    } else {
                                        document.getElementById('grayLabel').innerText += button;
                                    }
                                }
                            }
                        });
                    }
                });
                scoreButtons.appendChild(div);
            });
            scoreButtons.style.display = 'block';
        }

        window.onload = function () {
            var player1 = getCookie('player1');
            if (player1 != "") {
                document.getElementById('player1').value = player1;
            }

            var player2 = getCookie('player2');
            if (player2 != "") {
                document.getElementById('player2').value = player2;
            }
        };

        function resetTurn() {
            document.getElementById('circle').style.display = 'none';  // Nasconde il cerchio quando si cambia giocatore
            document.getElementById('whiteLabel').innerText = ''; // Resetta il punteggio
            document.getElementById('grayLabel').innerText = ''; // Resetta il punteggio
            if (biglie === 0) {// avevo segnato il punto e devo resettare
                if (currentPlayer === 'player1') {
                    players.player1.points--;
                } else {
                    players.player2.points--;
                }
                document.getElementById('matchScore').innerText = players.player1.points + ' - ' + players.player2.points;
            }
            players[currentPlayer].biglie -= biglieInizioTurno - biglie;
            biglie = biglieInizioTurno;
            if (biglie === 9) {
                isStartOfGame = true;
            }
            toggleButtons(biglie);
            lastButtonIsNumeric = false;
        }

        $(function () {
            $('#playersGroup label').on('click', function () {
                $(this).addClass('active').siblings().removeClass('active');
                if (biglie === 0) {
                    biglie = 9;
                    isStartOfGame = true;
                    isBreakShotComplete = false;
                } else {
                    isBreakShotComplete = true;
                }
                document.getElementById('circle').style.display = 'none';  // Nasconde il cerchio quando si cambia giocatore
                document.getElementById('whiteLabel').innerText = ''; // Resetta il punteggio
                document.getElementById('grayLabel').innerText = ''; // Resetta il punteggio
                currentPlayer = this.id === 'player1Label' ? 'player1' : 'player2';            
                biglieInizioTurno = biglie;   
                toggleButtons(biglie);         
            });
        });

        document.getElementById('whiteLabel').addEventListener('click', function () {// quando cancello il bianco devo resettare tutto il turno. E' come se avessi cambiato giocatore
            resetTurn();

        });

        document.getElementById('grayLabel').addEventListener('click', function () {
            this.innerText = '';
        });

    </script>
</body>

</html>