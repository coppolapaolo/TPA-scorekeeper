<!DOCTYPE html>
<html>

<head>
    <title>Player Match</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js"></script>
    <style>
        body {
            background: #f5f5f5;
        }

        .container {
            max-width: 960px;
        }

        .btn-group-toggle .btn {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-group-toggle .btn:not(.active) {
            color: #007bff;
            background-color: #fff;
            border-color: #007bff;
        }

        .btn-group .btn {
            color: #007bff;
            background-color: #fff;
            border-color: #007bff;
        }

        .btn-square {
            width: 50px;
            height: 50px;
            margin: 0.3em;
        }

        .border-container {
            display: inline-block;
            position: relative;
        }

        .circle {
            position: absolute;
            top: 5%;
            left: 5%;
            width: 80%;
            height: 80%;
            border-radius: 50%;
            border: 2px solid black;
            pointer-events: none;
        }

        #whiteLabel,
        #grayLabel {
            font-size: 2.5em;
        }

        .container {
            overflow-x: hidden;
        }
        .canvas-container {
            width: 80%; 
            margin: 0 auto; 
            min-height: calc(1.5em + 1rem); 
        }
        
        .canvas-container canvas {
            height: 100% !important; 
            display: block;
        }        
    </style>
</head>

<body>
    <div class="container py-5">
        <form id="playerForm" class="mb-5">
            <div class="form-group">
                <label for="player1">Player 1</label>
                <input type="text" class="form-control" id="player1" placeholder="Inserisci il nome del giocatore 1"
                    onchange="saveNames()">
            </div>
            <div class="form-group">
                <label for="player2">Player 2</label>
                <input type="text" class="form-control" id="player2" placeholder="Inserisci il nome del giocatore 2"
                    onchange="saveNames()">
            </div>
            <button type="button" class="btn btn-primary" onclick="startMatch()">Start</button>
        </form>
        <h3 id="dateTitle" class="text-center mb-5" style="display: none;"></h3>
        <div id="matchContent" style="display: none;">
            <div id="players" class="justify-content-center mb-5 flex-column" style="display: none;">
                <div id="playersGroup" class="d-flex btn-group btn-group-toggle" data-toggle="buttons"
                    style="display: none;">
                    <label id="player1Label" class="btn btn-primary active">
                        <input type="radio" name="playerOptions" id="player1Option" autocomplete="off" checked> Player1
                    </label>
                    <label id="player2Label" class="btn btn-primary">
                        <input type="radio" name="playerOptions" id="player2Option" autocomplete="off"> Player2
                    </label>
                </div>
                <div id="matchScore" class="w-100" style="font-size: tiny; text-align: center;">(0,0,NaN) <strong>0 - 0</strong> (0,0,NaN)</div>
            </div>
            <div id="squareLabels" class="d-flex justify-content-center mb-5" style="display: none;">
                <div class="border-container">
                    <label id="whiteLabel" class="border"
                        style="width: 70px; height: 70px; background-color: white; display: flex; justify-content: center; align-items: center; font-size: 28px;"></label>
                    <span id="circle" class="circle" style="display: none;"></span>
                </div>
                <label id="grayLabel" class="border"
                    style="width: 70px; height: 70px; background-color: lightgray; display: flex; justify-content: center; align-items: center; font-size: 28px;"></label>
            </div> 
            <div id="scoreButtons" class="container" style="display: none;">
                <!-- Score buttons will be added here by JavaScript -->
            </div>
        </div>
        <div id="endMatch" class="justify-content-center mb-5 flex-column" style="display: none;">
            <button type="button" class="btn btn-primary" onclick="endMatch()">End Match</button>
        </div>
        <div id="results" class="justify-content-center mb-5 flex-column" style="display: none;">
        </div>
    </div>

    <script>
        let debugging = false;
        let balls = 9;
        let players = {
            player1: { points: 0, balls: 0, errors: 0, tpaScore: 0 , scores: [], tpaScores: []},
            player2: { points: 0, balls: 0, errors: 0, tpaScore: 0 , scores: [], tpaScores: []}
        };
        let currentPlayer = 'player1';
        let isStartOfGame = true;
        let isBreakShot = true;
        let isBreakShotComplete = false;
        let ballsTurnStart = 0; 
        let switchCauseOfPush = false;
        let lastBalls = 0;
        let lastIsSafe = false;
        let playersButtonEnabled = true;
        let ballsPocketedInBreak = 0;
        let gameEnded = false;
        let firstShotAfterBreak = false; // only on the first shot after the break can you opt for the push


        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function saveNames() {
            var player1 = document.getElementById('player1').value;
            var player2 = document.getElementById('player2').value;

            var d = new Date();
            d.setTime(d.getTime() + (60 * 60 * 24 * 60 * 1000)); // Two months
            var expires = "expires=" + d.toUTCString();

            document.cookie = "player1=" + player1 + ";" + expires + ";path=/";
            document.cookie = "player2=" + player2 + ";" + expires + ";path=/";
        }

        function toggleButtons() {
            // toggleButtons() enables all numeric buttons and disables all letter buttons
            // toggleButtons(3) disables buttons from 4 to 9 and disables all others
            // toggleButtons(-2) enables buttons from 1 to 2 and disables all others
            // toggleButtons([1,3,q]) enables buttons 1, 3, and q and disables all others
            // toggleButtons([M, N, x],[1,3,q]) disables buttons M, N, and x and enables buttons 1, 3, and q

            if (arguments.length === 0) {
                document.querySelectorAll('.btn-square').forEach(function (btn) {
                    if (!isNaN(btn.textContent)) {
                        btn.disabled = false;
                    } else {
                        //btn.disabled = true;
                        btn.style.display = 'none';
                    }
                });
            } else if (arguments.length === 1) {
                if (typeof arguments[0] === 'number') {
                    var tmp = arguments[0];
                    if (arguments[0] > 0) {
                        document.querySelectorAll('.btn-square').forEach(function (btn) {
                            if (!isNaN(btn.textContent)) {
                                btn.style.display = "";
                                if(parseInt(btn.textContent) > tmp) {
                                    btn.disabled = true;
                                } else {
                                    btn.disabled = false;
                                }
                            } else {
                                btn.style.display = 'none';
                            }
                        });    
                    } else {
                        document.querySelectorAll('.btn-square').forEach(function (btn) {
                            if (!isNaN(btn.textContent)) {
                                btn.style.display = "";
                                if (parseInt(btn.textContent) <= -tmp && parseInt(btn.textContent) > 0) {
                                    btn.disabled = false;
                                } else {
                                    btn.disabled = true;
                                }
                            } else {
                                btn.style.display = 'none';
                            }   
                        });
                    }
                } else if (Array.isArray(arguments[0])) {
                    var tmp = arguments[0];
                    if (tmp[0] == 0) {
                        document.querySelectorAll('.btn-square').forEach(function (btn) {
                            if (!isNaN(btn.textContent)) {
                                btn.style.display = "";
                                if(parseInt(btn.textContent) > 0 && parseInt(btn.textContent) < tmp[1]) {
                                    btn.disabled = true;
                                } else {
                                    btn.disabled = false;
                                }
                            } else {
                                btn.style.display = 'none';
                            }
                        });    
                    } else {
                        document.querySelectorAll('.btn-square').forEach(function (btn) {
                            if (tmp.includes(btn.textContent)) {
                                btn.style.display = "";
                                btn.disabled = false;
                            } else {
                                btn.style.display = 'none';
                            }
                        });    
                    }
                }
            } else {
                var buttonEnabled = arguments[0];
                var buttonsDisabled = arguments[1];
                document.querySelectorAll('.btn-square').forEach(function (btn) {
                    btn.style.display = "";
                    if (buttonEnabled.includes(btn.textContent)) {                       
                        btn.disabled = false;
                    } else if (buttonsDisabled.includes(btn.textContent)) {
                        btn.disabled = true;
                    }
                });
            }   
        }

        function initGame() {
            balls = 9;
            isStartOfGame = true;
            isBreakShot = true;
            isBreakShotComplete = false;
            switchCauseOfPush = false;
            lastBalls = 0;
            ballsPocketedInBreak = 0;
            gameEnded = false;
            firstShotAfterBreak = false;
        }

        function updateScore() {
            players.player1.tpaScore = Math.round(players.player1.balls / (players.player1.errors + players.player1.balls) * 1000);
            players.player2.tpaScore = Math.round(players.player2.balls / (players.player2.errors + players.player2.balls) * 1000);
            document.getElementById('matchScore').innerHTML = '('+players.player1.balls+','+players.player1.errors+','+players.player1.tpaScore+')<strong>'+players.player1.points + ' - ' 
                + players.player2.points + '</strong>(' + players.player2.balls + ',' + players.player2.errors + ',' + players.player2.tpaScore + ')';  
            if (isBreakShot && debugging) {
                document.getElementById('whiteLabel').style.backgroundColor = 'lightgreen';
            } else if (!isBreakShotComplete && debugging) {
                document.getElementById('whiteLabel').style.backgroundColor = 'lightblue';
            } else {
                document.getElementById('whiteLabel').style.backgroundColor = 'white';
            }
        }


        function startMatch() {
            initGame();
            ballsTurnStart = balls;
            players.player1.points = 0;
            players.player2.points = 0;
            players.player1.balls = 0;
            players.player2.balls = 0;
            players.player1.errors = 0;
            players.player2.errors = 0;
            players.player1.tpaScore = 0;
            players.player2.tpaScore = 0;
            players.player1.scores = [];
            players.player2.scores = [];
            players.player1.tpaScores = [];
            players.player2.tpaScores = [];
            currentPlayer = 'player1';

            document.getElementById('playerForm').style.display = 'none';
            document.getElementById('endMatch').style.display = 'flex';

            var date = new Date();
            document.getElementById('dateTitle').innerHTML = date.toDateString();
            document.getElementById('dateTitle').style.display = 'block';
            document.getElementById('squareLabels').style.display = 'flex';

            document.querySelector('.justify-content-center.mb-5.flex-column').style.display = 'flex';
            var player1 = getCookie('player1');
            var player2 = getCookie('player2');
            document.getElementById('player1Label').textContent = player1;
            document.getElementById('player2Label').textContent = player2;
            document.getElementById('matchContent').style.display = 'block';
            document.getElementById('playersGroup').style.display = 'block';

            var scoreButtons = document.getElementById('scoreButtons');
            var buttons = [
                [null, '1', '2', '3', null],
                [null, '4', '5', '6', null],
                [null, '7', '8', '9', null],
                [null, '0', null],
                [null ,'G', null],
                [null, 'M', 'K', 'S', null],
                [null, 'P', null, 'N', null],
                [null, 'n', 'x', 'p', null]
            ];

            buttons.forEach(function (row) {
                var div = document.createElement('div');
                div.className = 'row justify-content-center mb-2';
                row.forEach(function (button) {
                    var col = document.createElement('div');
                    if (button === null) {
                        col.className = 'col-2';
                    } else {
                        col.className = 'col-2';
                        var btn = document.createElement('button');
                        btn.className = 'btn btn-secondary btn-square';
                        btn.textContent = button;
                        if (isNaN(button)) {
                            btn.style.display = 'none';
                        }
                        col.appendChild(btn);
                    }
                    div.appendChild(col);
                    if (button !== null) {
                        btn.addEventListener('click', function () {
                            if (!isNaN(button)) {
                                if (isBreakShot) {
                                    playersButtonEnabled  = false;
                                    lastBalls = button;
                                    firstShotAfterBreak = true;
                                    if (button == 0) {
                                        document.getElementById('whiteLabel').innerText = button;
                                        toggleButtons(['P', 'N']);
                                        playersButtonEnabled  = true;
                                        isBreakShot = false;
                                        isBreakShotComplete = true;
                                    } else if (button < 9) {
                                        document.getElementById('whiteLabel').innerHTML = '<sup>' + button + '</sup>'
                                        playersButtonEnabled  = false
                                        toggleButtons([0,parseInt(button)]); // 0 for pocketing the cue ball. From button+1 to 9 for the round
                                        balls -= button;
                                        players[currentPlayer].balls += parseInt(button);
                                        isBreakShot = false;
                                        isBreakShotComplete = false;
                                        ballsPocketedInBreak = button;
                                    } else {// the miracle shot
                                        document.getElementById('whiteLabel').innerHTML = '<sup>' + button + '</sup>' + button
                                        document.getElementById('circle').style.display = 'block';
                                        balls -= button;
                                        gameEnded = true;
                                        players[currentPlayer].balls += parseInt(button);
                                        players[currentPlayer].points++;
                                        updateScore();
                                        isBreakShot = false;
                                        isBreakShotComplete = true;
                                        playersButtonEnabled  = true;
                                    }
                                } else if (!isBreakShotComplete) {
                                    document.getElementById('whiteLabel').innerHTML = document.getElementById('whiteLabel').innerHTML + button;
                                    if (button > 0) {
                                        balls = balls + (lastBalls - parseInt(button));
                                        players[currentPlayer].balls = players[currentPlayer].balls - parseInt(lastBalls) + parseInt(button);
                                    } else {
                                        players[currentPlayer].balls = players[currentPlayer].balls - parseInt(lastBalls);
                                        document.getElementById('grayLabel').innerText += 'P';
                                    }
                                    if (button == lastBalls && lastBalls > 0) {
                                        toggleButtons(['M', 'K', 'S', 'G','p', 'P']);
                                    } else if (button == 0) {
                                        toggleButtons([]); // then switch player
                                    } else {
                                        toggleButtons(['M', 'K', 'S', 'G','P']);
                                        firstShotAfterBreak = false;
                                        lastBalls = button;
                                    }
                                    playersButtonEnabled  = (button == 0);
                                } else if (switchCauseOfPush) {
                                    firstShotAfterBreak = false;
                                    playersButtonEnabled  = false;
                                    lastBalls = button;
                                    if (button == 0) {
                                        toggleButtons(['S','K','M','p']);
                                        document.getElementById('whiteLabel').innerText = button;
                                    } else {
                                        switchCauseOfPush = false;
                                        lastPlayer = currentPlayer === 'player1' ? 'player2' : 'player1';
                                        players[lastPlayer].errors++; // failing to execute a safety succesfully 
                                        document.getElementById('whiteLabel').innerText = button;
                                        balls -= button;
                                        players[currentPlayer].balls += parseInt(button);
                                        if (balls == 0) {
                                            gameEnded = true;
                                            players[currentPlayer].points++;
                                            isBreakShotComplete = true;
                                            updateScore();
                                            playersButtonEnabled  = true;
                                            document.getElementById('circle').style.display = 'block';
                                            toggleButtons([]);
                                        } else {
                                            toggleButtons(['S', 'K', 'M', 'G','P']);
                                            playersButtonEnabled  = false;
                                        }
                                    }
                                } else {
                                    playersButtonEnabled  = false;
                                    players[currentPlayer].balls += parseInt(button);
                                    balls -= button;
                                    lastBalls = button;
                                    switchCauseOfPush = false;
                                    document.getElementById('whiteLabel').innerText = button;
                                    if (balls == 0) { // winning game shot
                                        gameEnded = true;
                                        players[currentPlayer].points++;
                                        isBreakShotComplete = true;
                                        updateScore();
                                        playersButtonEnabled  = true;
                                        toggleButtons([]);
                                        document.getElementById('circle').style.display = 'block';
                                    } else {
                                        if (button > 0) {
                                            if (lastIsSafe) {
                                                lastPlayer = currentPlayer === 'player1' ? 'player2' : 'player1';
                                                players[lastPlayer].errors++; // failing to execute a safety succesfully
                                            }
                                            toggleButtons(['S', 'K', 'M', 'G','P']);
                                        } else {
                                            if (firstShotAfterBreak) {
                                                toggleButtons(['S', 'K', 'M','p']);
                                            } else {
                                                toggleButtons(['S', 'K', 'M']);
                                            }
                                        }
                                        playersButtonEnabled  = false;
                                        firstShotAfterBreak = false;
                                    }
                                    lastIsSafe = false;
                                }
                            } else if (button === 'G') {
                                gameEnded = true;
                                players[currentPlayer].points++; 
                                document.getElementById('circle').style.display = 'block';
                                playersButtonEnabled  = true;
                                isBreakShotComplete = true;
                                balls = 0;
                                toggleButtons([]);
                                updateScore();
                            } else if (button == 'M') {
                                document.getElementById('whiteLabel').innerHTML = document.getElementById('whiteLabel').innerHTML+'M';
                                lastIsSafe = false;
                                players[currentPlayer].errors++; //missing a shot
                                playersButtonEnabled  = true;
                                if (lastBalls > 0) {//getting out of position
                                    players[currentPlayer].errors++;
                                    toggleButtons(['n','P', 'N']);
                                } else {
                                    toggleButtons(['P', 'N']);
                                }
                            } else if (button == 'K') {
                                document.getElementById('whiteLabel').innerHTML = document.getElementById('whiteLabel').innerHTML+'K';
                                lastIsSafe = false;
                                players[currentPlayer].errors++; //missing a shot
                                playersButtonEnabled  = true;
                                if (lastBalls > 0) {//getting out of position
                                    players[currentPlayer].errors++;
                                }
                                toggleButtons(['P', 'N']);
                            } else if (button == 'S') {
                                lastIsSafe = true;
                                if (lastBalls == ballsPocketedInBreak && !isBreakShotComplete) {
                                    document.getElementById('whiteLabel').innerHTML = document.getElementById('whiteLabel').innerHTML+'S';
                                    toggleButtons(['P', 'N']);
                                    playersButtonEnabled  = true;
                                    // no position error (?)
                                } else if (switchCauseOfPush && lastBalls == 0) {
                                    document.getElementById('whiteLabel').innerHTML = document.getElementById('whiteLabel').innerHTML+'S';
                                    switchCauseOfPush = false;
                                    toggleButtons(['P', 'N']); 
                                    playersButtonEnabled  = true;
                                } else {
                                    document.getElementById('whiteLabel').innerHTML = document.getElementById('whiteLabel').innerHTML+'S';
                                    switchCauseOfPush = false;
                                    if (lastBalls > 0) {// getting out of position
                                        players[currentPlayer].errors++;
                                        toggleButtons(['P', 'N','x']);
                                    } else {
                                        toggleButtons(['P', 'N']);
                                    }
                                    playersButtonEnabled  = true;
                                }
                            } else if (['P', 'N'].includes(button)) {
                                document.getElementById('grayLabel').innerText += button;
                                players[currentPlayer].errors++;
                                playersButtonEnabled  = true;
                                isBreakShotComplete = true;
                                firstShotAfterBreak = false;
                                toggleButtons([]);
                            } else if (['n','x'].includes(button)) {// no position error
                                players[currentPlayer].errors--;
                                toggleButtons(['P', 'N']);
                                document.getElementById('whiteLabel').innerHTML = document.getElementById('whiteLabel').innerHTML + '<sup>' + button + '</sup>';
                                playersButtonEnabled  = true;
                            } else if (button == 'p') {
                                document.getElementById('whiteLabel').innerHTML = document.getElementById('whiteLabel').innerHTML + 'S<sup>p</sup>';
                                switchCauseOfPush = !switchCauseOfPush;
                                playersButtonEnabled  = true;
                                toggleButtons([]);
                            }
                            updateScore();
                        });
                    }
                });
                scoreButtons.appendChild(div);
            });
            scoreButtons.style.display = 'block';
            saveTurnState("Start");
            saveTurnState("End");
        }

        window.onload = function () {
            var player1 = getCookie('player1');
            if (player1 != "") {
                document.getElementById('player1').value = player1;
            }

            var player2 = getCookie('player2');
            if (player2 != "") {
                document.getElementById('player2').value = player2;
            }
        };

        function switchPlayer() {
            var activeLabel = $('#playersGroup label.active');
            var nextLabel = activeLabel.siblings();
          
            activeLabel.removeClass('active');
          
            nextLabel.addClass('active');
          
          }
          
        function resetTurn(Time) {
            balls = parseInt(document.cookie.split('; ').find(row => row.startsWith('ballsTurnState'+Time)).split('=')[1]);
            if (Time == "Start") {
                document.getElementById('circle').style.display = 'none';  
                document.getElementById('whiteLabel').innerText = ''; 
                document.getElementById('grayLabel').innerText = ''; 
                toggleButtons(balls);            
            } else {
                document.getElementById('circle').style.display = document.cookie.split('; ').find(row => row.startsWith('circleTurnState'+Time)).split('=')[1];
                document.getElementById('whiteLabel').innerHTML = document.cookie.split('; ').find(row => row.startsWith('whiteLabelTurnState'+Time)).split('=')[1];
                document.getElementById('grayLabel').innerText = document.cookie.split('; ').find(row => row.startsWith('grayLabelTurnState'+Time)).split('=')[1];
                var buttonEnabled = document.cookie.split('; ').find(row => row.startsWith('buttonsEnabledTurnState'+Time)).split('=')[1].split(',');
                switchPlayer();
                toggleButtons(buttonEnabled);
            }
            players.player1.points = parseInt(document.cookie.split('; ').find(row => row.startsWith('player1PointsTurnState'+Time)).split('=')[1]);
            players.player2.points = parseInt(document.cookie.split('; ').find(row => row.startsWith('player2PointsTurnState'+Time)).split('=')[1]);
            players.player1.balls = parseInt(document.cookie.split('; ').find(row => row.startsWith('player1BallsTurnState'+Time)).split('=')[1]);
            players.player2.balls = parseInt(document.cookie.split('; ').find(row => row.startsWith('player2BallsTurnState'+Time)).split('=')[1]);
            players.player1.errors = parseInt(document.cookie.split('; ').find(row => row.startsWith('player1ErrorsTurnState'+Time)).split('=')[1]);
            players.player2.errors = parseInt(document.cookie.split('; ').find(row => row.startsWith('player2ErrorsTurnState'+Time)).split('=')[1]);
            players.player1.tpaScore = document.cookie.split('; ').find(row => row.startsWith('player1TpaScoreTurnState'+Time)).split('=')[1];
            players.player2.tpaScore = document.cookie.split('; ').find(row => row.startsWith('player2TpaScoreTurnState'+Time)).split('=')[1];
            currentPlayer = document.cookie.split('; ').find(row => row.startsWith('currentPlayerTurnState'+Time)).split('=')[1];
            isStartOfGame = document.cookie.split('; ').find(row => row.startsWith('isStartOfGameTurnState'+Time)).split('=')[1] == 'true';
            isBreakShot = document.cookie.split('; ').find(row => row.startsWith('isBreakShotTurnState'+Time)).split('=')[1] == 'true';
            firstShotAfterBreak = document.cookie.split('; ').find(row => row.startsWith('firstShotAfterBreakTurnState'+Time)).split('=')[1] == 'true';
            isBreakShotComplete = document.cookie.split('; ').find(row => row.startsWith('isBreakShotCompleteTurnState'+Time)).split('=')[1] == 'true';
            ballsTurnStart = parseInt(document.cookie.split('; ').find(row => row.startsWith('ballsTurnStartTurnState'+Time)).split('=')[1]);
            switchCauseOfPush = document.cookie.split('; ').find(row => row.startsWith('switchCauseOfPushTurnState'+Time)).split('=')[1] == 'true';
            lastBalls = parseInt(document.cookie.split('; ').find(row => row.startsWith('lastBallsTurnState'+Time)).split('=')[1]);
            lastIsSafe = document.cookie.split('; ').find(row => row.startsWith('lastIsSafeTurnState'+Time)).split('=')[1] == 'true';
            playersButtonEnabled = document.cookie.split('; ').find(row => row.startsWith('playersButtonEnabledTurnState'+Time)).split('=')[1] == 'true';
            ballsPocketedInBreak = parseInt(document.cookie.split('; ').find(row => row.startsWith('ballsPocketedInBreakTurnState'+Time)).split('=')[1]);
            gameEnded = document.cookie.split('; ').find(row => row.startsWith('gameEndedTurnState'+Time)).split('=')[1] == 'true';
            updateScore();
            players[currentPlayer].scores.pop();
            players[currentPlayer].tpaScores.pop();
        }

        function saveTurnState(Time) {
            if (Time == 'End') {// saves white and gray labels in current player scores
                players[currentPlayer].scores.push(document.getElementById("squareLabels").cloneNode(true).outerHTML);
                players[currentPlayer].tpaScores.push(players[currentPlayer].tpaScore);
            }
            var d = new Date();
            d.setTime(d.getTime() + (60 * 60 * 24 * 60 * 1000)); // Two months
            var expires = "expires=" + d.toUTCString();

            document.cookie = "ballsTurnState" + Time + "=" + balls + ";" + expires + ";path=/";
            document.cookie = "player1PointsTurnState" + Time + "=" + players.player1.points + ";" + expires + ";path=/";
            document.cookie = "player2PointsTurnState" + Time + "=" + players.player2.points + ";" + expires + ";path=/";
            document.cookie = "player1BallsTurnState" + Time + "=" + players.player1.balls + ";" + expires + ";path=/";
            document.cookie = "player2BallsTurnState" + Time + "=" + players.player2.balls + ";" + expires + ";path=/";
            document.cookie = "player1ErrorsTurnState" + Time + "=" + players.player1.errors + ";" + expires + ";path=/";
            document.cookie = "player2ErrorsTurnState" + Time + "=" + players.player2.errors + ";" + expires + ";path=/";
            document.cookie = "player1TpaScoreTurnState" + Time + "=" + players.player1.tpaScore + ";" + expires + ";path=/";
            document.cookie = "player2TpaScoreTurnState" + Time + "=" + players.player2.tpaScore + ";" + expires + ";path=/";
            document.cookie = "currentPlayerTurnState" + Time + "=" + currentPlayer + ";" + expires + ";path=/";
            document.cookie = "isStartOfGameTurnState" + Time + "=" + isStartOfGame + ";" + expires + ";path=/";
            document.cookie = "isBreakShotTurnState" + Time + "=" + isBreakShot + ";" + expires + ";path=/";
            document.cookie = "firstShotAfterBreakTurnState" + Time + "=" + firstShotAfterBreak + ";" + expires + ";path=/";
            document.cookie = "isBreakShotCompleteTurnState" + Time + "=" + isBreakShotComplete + ";" + expires + ";path=/";
            document.cookie = "ballsTurnStartTurnState" + Time + "=" + ballsTurnStart + ";" + expires + ";path=/";
            document.cookie = "switchCauseOfPushTurnState" + Time + "=" + switchCauseOfPush + ";" + expires + ";path=/";
            document.cookie = "lastBallsTurnState" + Time + "=" + lastBalls + ";" + expires + ";path=/";
            document.cookie = "lastIsSafeTurnState" + Time + "=" + lastIsSafe + ";" + expires + ";path=/";
            document.cookie = "playersButtonEnabledTurnState" + Time + "=" + playersButtonEnabled + ";" + expires + ";path=/";
            document.cookie = "ballsPocketedInBreakTurnState" + Time + "=" + ballsPocketedInBreak + ";" + expires + ";path=/";
            document.cookie = "gameEndedTurnState" + Time + "=" + gameEnded + ";" + expires + ";path=/";
            document.cookie = "circleTurnState" + Time + "=" + document.getElementById('circle').style.display + ";" + expires + ";path=/";
            document.cookie = "whiteLabelTurnState" + Time + "=" + document.getElementById('whiteLabel').innerHTML + ";" + expires + ";path=/";
            document.cookie = "grayLabelTurnState" + Time + "=" + document.getElementById('grayLabel').innerText + ";" + expires + ";path=/";
            var buttonsEnabled = [];
            document.querySelectorAll('.btn-square').forEach(function (btn) {
                if (btn.style.display != 'none') {
                    buttonsEnabled.push(btn.textContent);
                }
            });
            document.cookie = "buttonsEnabledTurnState" + Time + "=" + buttonsEnabled + ";" + expires + ";path=/";
        }

        $(function () {
            $('#playersGroup label').on('click', function () {
                if (!playersButtonEnabled) return;
                saveTurnState("End");
                $(this).addClass('active').siblings().removeClass('active');
                if (gameEnded) {
                    initGame();
                } else if (balls == 9 && isBreakShot) {
                    playersButtonEnabled = true;
                    isBreakShotComplete = false;
                } else {
                    playersButtonEnabled = false;
                    isBreakShotComplete = true;
                }
                document.getElementById('circle').style.display = 'none';  
                document.getElementById('whiteLabel').innerText = ''; 
                document.getElementById('grayLabel').innerText = ''; 
                currentPlayer = this.id === 'player1Label' ? 'player1' : 'player2';            
                ballsTurnStart = balls;   
                toggleButtons(balls);      
                updateScore();
                saveTurnState("Start");
            });
        });

        document.getElementById('whiteLabel').addEventListener('click', function () {
            resetTurn("Start");

        });

        document.getElementById('grayLabel').addEventListener('click', function () {
            resetTurn("End");
        });

        function endMatch() {
            var confirmation = window.confirm("This will end the match. Are you sure?");
          
            if (!confirmation) return;

            saveTurnState("End");
          
            var tableHtml = '<div class="container"><table class="table table-bordered"><thead class="thead-dark"><tr><th class="h4 text-center">'+document.getElementById('player1Label').innerText+'</th><th class="h4 text-center">'+document.getElementById('player2Label').innerText+'</th></tr></thead><tbody>';
            tableHtml += '<tr><td class="h5 text-center">' + players.player1.points + '</td><td class="h5 text-center">' + players.player2.points + '</td></tr>';
            tableHtml += '<tr><td class="h6 text-center">' + players.player1.tpaScore + '</td><td class="h6 text-center">' + players.player2.tpaScore + '</td></tr>';
            tableHtml += '<tr><td class="text-center"><div class="canvas-container"><canvas id="player1canvas"></canvas></div></td><td class="text-center"><div class="canvas-container"><canvas id="player2canvas"></canvas></div></td></tr>';
                
          
            for (var i = 0; i < Math.max(players.player1.scores.length, players.player2.scores.length); i++) {
              tableHtml += '<tr>';
              tableHtml += '<td>' + (players.player1.scores[i+1] || '') + '</td>';
              tableHtml += '<td>' + (players.player2.scores[i] || '') + '</td>';
              tableHtml += '</tr>';
            }
          
            tableHtml += '</tbody></table></div>';
            document.getElementById("results").innerHTML = tableHtml;

            new Chart(document.getElementById('player1canvas').getContext('2d'), {
                type: 'line',
                data: {
                  labels: players.player1.tpaScores.slice(1).map((_, index) => index + 1), 
                  datasets: [{
                    label: 'tpa score',
                    data: players.player1.tpaScores.slice(1),
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    fill: false
                  }]
                },
                options: {
                  scales: {
                    x: {
                      beginAtZero: true
                    },
                    y: {
                      beginAtZero: true,
                      min: 0,
                      max: 1000
                    }
                  },
                  plugins: {
                    legend: {
                      display: false
                    }
                  }
                }
            });
            new Chart(document.getElementById('player2canvas').getContext('2d'), {
                type: 'line',
                data: {
                  labels: players.player2.tpaScores.map((_, index) => index + 1), 
                  datasets: [{
                    label: 'tpa score',
                    data: players.player2.tpaScores,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    fill: false
                  }]
                },
                options: {
                  scales: {
                    x: {
                      beginAtZero: true
                    },
                    y: {
                      beginAtZero: true,
                      min: 0,
                      max: 1000
                    }
                  },
                  plugins: {
                    legend: {
                      display: false 
                    }
                  }
                }
            });
          
            document.getElementById("results").style.display = 'flex';
            document.getElementById("matchContent").style.display = 'none';
            document.getElementById("endMatch").style.display = 'none';
          }
          

    </script>
</body>

</html>